<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Community Board</title>
    <!-- êµ¬ê¸€ í°íŠ¸ & ì•„ì´ì½˜ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* [ìŠ¤íƒ€ì¼] ì„¸ë ¨ëœ ëª¨ë˜ UI */
        :root {
            --primary: #4F46E5;
            --bg-color: #F3F4F6;
            --card-bg: #ffffff;
            --text-main: #1F2937;
            --text-sub: #6B7280;
        }

        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; background: var(--bg-color); color: var(--text-main); }
        
        /* í—¤ë” */
        header { background: var(--card-bg); padding: 1rem 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); text-decoration: none; }
        .user-info { display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4338ca; }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: var(--text-main); }
        .btn-outline:hover { background: #f9fafb; }

        /* ì»¨í…Œì´ë„ˆ */
        .container { max-width: 800px; margin: 2rem auto; padding: 0 1rem; }

        /* í™”ë©´ ì „í™˜ìš© (ë¡œê·¸ì¸ ì „/í›„, ê¸€ì“°ê¸° ë“±) */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }

        /* ë¡œê·¸ì¸ í¼ */
        .login-box { background: var(--card-bg); padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; max-width: 400px; margin: 4rem auto; }
        .login-box h2 { margin-bottom: 1.5rem; }
        
        /* ê²Œì‹œíŒ ë¦¬ìŠ¤íŠ¸ */
        .board-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .post-card { background: var(--card-bg); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: transform 0.2s; cursor: pointer; }
        .post-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .post-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; }
        .post-meta { font-size: 0.85rem; color: var(--text-sub); display: flex; justify-content: space-between; }

        /* ê¸€ì“°ê¸° í¼ */
        .write-box { background: var(--card-bg); padding: 2rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input-group input, .input-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.375rem; font-family: inherit; box-sizing: border-box; }
        .input-group textarea { height: 200px; resize: vertical; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<header>
    <a href="#" class="logo" onclick="showBoard()">Parkstery Board</a>
    <div class="user-info">
        <span id="user-display" style="display:none;">í™˜ì˜í•©ë‹ˆë‹¤!</span>
        <button id="btn-login" class="btn btn-primary" onclick="googleLogin()">Google ë¡œê·¸ì¸</button>
        <button id="btn-logout" class="btn btn-outline" style="display:none;" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
</header>

<div class="container">
    <!-- 1. ë¡œê·¸ì¸ í•„ìš” í™”ë©´ -->
    <div id="view-login-required" class="view-section active">
        <div class="login-box">
            <i class="fas fa-lock fa-3x" style="color: #ddd; margin-bottom: 1rem;"></i>
            <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
            <p style="color: var(--text-sub); margin-bottom: 2rem;">ê²Œì‹œê¸€ì„ ë³´ê±°ë‚˜ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" style="width: 100%;" onclick="googleLogin()">
                <i class="fab fa-google"></i> êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
            </button>
        </div>
    </div>

    <!-- 2. ê²Œì‹œíŒ ëª©ë¡ í™”ë©´ -->
    <div id="view-board" class="view-section">
        <div class="board-header">
            <h3>ğŸ“ ììœ  ê²Œì‹œíŒ</h3>
            <button class="btn btn-primary" onclick="showWrite()">ê¸€ì“°ê¸°</button>
        </div>
        <div id="post-list">
            <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ê¸€ ëª©ë¡ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
            <div style="text-align:center; padding: 2rem; color:#888;">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <!-- 3. ê¸€ì“°ê¸° í™”ë©´ -->
    <div id="view-write" class="view-section">
        <div class="write-box">
            <h3 style="margin-top:0;">ìƒˆ ê¸€ ì‘ì„±</h3>
            <div class="input-group">
                <label>ì œëª©</label>
                <input type="text" id="title-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="input-group">
                <label>ë‚´ìš©</label>
                <textarea id="content-input" placeholder="ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì‘ì„±í•˜ì„¸ìš”"></textarea>
            </div>
            <div style="text-align: right;">
                <button class="btn btn-outline" onclick="showBoard()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="savePost()">ë“±ë¡í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDK -->
<script type="module">
    // 1. Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. Firebase ì„¤ì • (ë³¸ì¸ì˜ í‚¤ë¡œ êµì²´í•´ì•¼ í•¨)
    const firebaseConfig = {
        apiKey: "ì—¬ê¸°ì—_API_KEY_ì…ë ¥",
        authDomain: "ì—¬ê¸°ì—_AUTH_DOMAIN_ì…ë ¥",
        projectId: "ì—¬ê¸°ì—_PROJECT_ID_ì…ë ¥",
        storageBucket: "ì—¬ê¸°ì—_STORAGE_BUCKET_ì…ë ¥",
        messagingSenderId: "ì—¬ê¸°ì—_SENDER_ID_ì…ë ¥",
        appId: "ì—¬ê¸°ì—_APP_ID_ì…ë ¥"
    };

    // 3. ì•± ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´

    // [ì¸ì¦] ë¡œê·¸ì¸ í•¨ìˆ˜ (ì „ì—­ window ê°ì²´ì— ì—°ê²°)
    window.googleLogin = () => {
        signInWithPopup(auth, provider)
            .then((result) => {
                console.log("ë¡œê·¸ì¸ ì„±ê³µ:", result.user);
            }).catch((error) => {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
                alert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    };

    // [ì¸ì¦] ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
    window.logout = () => {
        signOut(auth).then(() => {
            alert("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        });
    };

    // [ì¸ì¦] ìƒíƒœ ë³€ê²½ ê°ì§€ (ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì‹œ ìë™ ì‹¤í–‰)
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // ë¡œê·¸ì¸ ìƒíƒœ
            currentUser = user;
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('btn-logout').style.display = 'block';
            document.getElementById('user-display').style.display = 'inline';
            document.getElementById('user-display').textContent = `${user.displayName}ë‹˜`;
            
            showBoard(); // ê²Œì‹œíŒ ë³´ì—¬ì£¼ê¸°
            loadPosts(); // ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        } else {
            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
            currentUser = null;
            document.getElementById('btn-login').style.display = 'block';
            document.getElementById('btn-logout').style.display = 'none';
            document.getElementById('user-display').style.display = 'none';
            
            showLoginRequired(); // ë¡œê·¸ì¸ ìœ ë„ í™”ë©´
        }
    });

    // [DB] ê¸€ ì €ì¥ í•¨ìˆ˜
    window.savePost = async () => {
        const title = document.getElementById('title-input').value;
        const content = document.getElementById('content-input').value;

        if(!title || !content) {
            alert("ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        try {
            await addDoc(collection(db, "posts"), {
                title: title,
                content: content,
                author: currentUser.displayName,
                uid: currentUser.uid,
                createdAt: serverTimestamp() // ì„œë²„ ì‹œê°„
            });
            alert("ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            document.getElementById('title-input').value = '';
            document.getElementById('content-input').value = '';
            showBoard();
            loadPosts();
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("ê¸€ ì €ì¥ ì‹¤íŒ¨: " + e.message);
        }
    };

    // [DB] ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
    async function loadPosts() {
        const listDiv = document.getElementById('post-list');
        listDiv.innerHTML = '<div style="text-align:center; padding:1rem;">ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);

        listDiv.innerHTML = ""; // ì´ˆê¸°í™”

        if (querySnapshot.empty) {
            listDiv.innerHTML = '<div style="text-align:center; padding:2rem;">ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>';
            return;
        }

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            // ë‚ ì§œ í¬ë§·íŒ…
            const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'ë°©ê¸ˆ ì „';
            
            const html = `
                <div class="post-card">
                    <div class="post-title">${escapeHtml(data.title)}</div>
                    <div class="post-meta">
                        <span><i class="fas fa-user"></i> ${escapeHtml(data.author)}</span>
                        <span>${date}</span>
                    </div>
                    <div style="margin-top:10px; color:#555; font-size:0.9rem; line-height:1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        ${escapeHtml(data.content)}
                    </div>
                </div>
            `;
            listDiv.innerHTML += html;
        });
    }

    // XSS ë°©ì§€ìš© í•¨ìˆ˜
    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;")
                   .replace(/</g, "&lt;")
                   .replace(/>/g, "&gt;")
                   .replace(/"/g, "&quot;")
                   .replace(/'/g, "&#039;");
    }

    // [UI] í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤
    window.showLoginRequired = () => {
        hideAll();
        document.getElementById('view-login-required').classList.add('active');
    };
    window.showBoard = () => {
        if(!currentUser) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        hideAll();
        document.getElementById('view-board').classList.add('active');
        loadPosts();
    };
    window.showWrite = () => {
        if(!currentUser) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
        hideAll();
        document.getElementById('view-write').classList.add('active');
    };
    function hideAll() {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    }
</script>

</body>
</html>
